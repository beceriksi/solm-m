import requests
import os
from google import genai

# Ayarlar
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
GEMINI_KEY = os.getenv("GEMINI_API_KEY")

# Yeni SDK ile Client kurulumu
client = genai.Client(api_key=GEMINI_KEY)

def get_ai_opinion(coin_info):
    prompt = f"Sen bir kripto uzmanÄ±sÄ±n. Bu coin bir 'narrative' sahibi mi? Bilgi: {coin_info}. Sadece 'POZÄ°TÄ°F: [Neden]' veya 'NEGATÄ°F' yaz."
    try:
        # Yeni SDK formatÄ±: models.generate_content
        response = client.models.generate_content(
            model='gemini-2.0-flash-001', # En hÄ±zlÄ± ve gÃ¼ncel model
            contents=prompt
        )
        return response.text
    except Exception as e:
        print(f"AI HatasÄ±: {e}")
        return "NEGATÄ°F"

def scan():
    url = "https://api.dexscreener.com/latest/dex/search?q=solana"
    try:
        res = requests.get(url).json()
        for pair in res.get('pairs', []):
            mcap = pair.get('fdv', 0)
            liq = pair.get('liquidity', {}).get('usd', 0)
            buys = pair.get('txns', {}).get('m5', {}).get('buys', 0)
            
            if 45000 <= mcap <= 85000 and liq >= (mcap * 0.12) and buys > 10:
                name = pair['baseToken']['name']
                desc = pair.get('info', {}).get('description', 'AÃ§Ä±klama yok')
                addr = pair['baseToken']['address']
                
                if pair.get('info', {}).get('socials'):
                    ai_decision = get_ai_opinion(f"Ä°sim: {name}, AÃ§Ä±klama: {desc}")
                    
                    if "POZÄ°TÄ°F" in ai_decision:
                        link = pair['url']
                        rugcheck_link = f"https://rugcheck.xyz/tokens/{addr}"
                        msg = (f"ðŸš€ *YENÄ° NESÄ°L ANALÄ°Z!*\n\n"
                               f"ðŸ’Ž *{name}*\n"
                               f"ðŸ’° MCAP: {mcap:,}$\n"
                               f"ðŸ§  AI: {ai_decision.replace('POZÄ°TÄ°F:', '')}\n\n"
                               f"ðŸ”— [GRAFÄ°K]({link}) | [RUGCHECK]({rugcheck_link})")
                        
                        requests.get(f"https://api.telegram.org/bot{TOKEN}/sendMessage?chat_id={CHAT_ID}&text={msg}&parse_mode=Markdown")
    except Exception as e:
        print(f"Genel Hata: {e}")

if __name__ == "__main__":
    scan()
